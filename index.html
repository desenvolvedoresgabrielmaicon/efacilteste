<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contatos e Equipes por Filial</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark-blue: #0a192f;
            --bg-light-blue: #112240;
            --accent-cyan: #64ffda;
            --text-primary: #ccd6f6;
            --text-secondary: #8892b0;
            --border-color: #233554;
            --shadow-color: rgba(2, 12, 27, 0.7);
            --highlight-bg: rgba(100, 255, 218, 0.1);
            --error-color: #e57373;
            --highlight-yellow: #FEEA00;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        @keyframes network-flow {
            0% { background-position: 0 0, 0 0, 0 0; }
            100% { background-position: -100px 100px, 50px -50px, 0 0; }
        }

        body {
            background-color: var(--bg-dark-blue);
            background-image:
                radial-gradient(circle at 25px 25px, var(--accent-cyan) 1px, transparent 2px),
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 50px 50px, 25px 25px, 25px 25px;
            background-attachment: fixed;
            animation: network-flow 5s linear infinite;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        #login-screen {
            background-color: var(--bg-light-blue);
            padding: 40px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px var(--shadow-color);
            z-index: 10;
        }
        
        #login-screen.hidden { display: none; }
        #login-screen h2 { color: var(--text-primary); font-size: 2em; margin-bottom: 10px; }
        #login-screen p { color: var(--text-secondary); margin-bottom: 30px; }

        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.9em; color: var(--text-secondary); }
        .input-group input { width: 100%; padding: 12px; background-color: var(--bg-dark-blue); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 1em; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-group input:focus { outline: none; border-color: var(--accent-cyan); box-shadow: 0 0 10px rgba(100, 255, 218, 0.2); }

        #login-button { width: 100%; padding: 15px; background-color: var(--accent-cyan); border: none; border-radius: 6px; color: var(--bg-dark-blue); font-size: 1.1em; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        #login-button:hover { background-color: #8fffe9; }
        #login-error { color: var(--error-color); margin-top: 15px; height: 1em; font-size: 0.9em; }

        .container { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 5; }
        .container.visible { display: flex; animation: fadeInContainer 0.5s ease-in-out; }
        @keyframes fadeInContainer { from { opacity: 0; } to { opacity: 1; } }
        
        .sidebar { width: 350px; background-color: var(--bg-light-blue); border-right: 1px solid var(--border-color); padding: 25px; overflow-y: auto; flex-shrink: 0; box-shadow: 5px 0 15px var(--shadow-color); display: flex; flex-direction: column; }
        .sidebar-header { margin-bottom: 20px; position: relative; }
        .sidebar-header h1 { color: var(--text-primary); font-size: 1.8em; font-weight: 700; }
        .sidebar-header p { color: var(--text-secondary); font-size: 0.9em; }

        .header-controls { position: absolute; top: 5px; right: 0; }
        #real-time-clock { font-family: 'Inter', sans-serif; font-size: 0.9em; font-weight: 500; color: var(--text-secondary); text-align: right; }
        
        .search-container { margin-bottom: 20px; }
        #search-bar { width: 100%; padding: 12px; background-color: var(--bg-dark-blue); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 1em; }
        #search-bar:focus { outline: none; border-color: var(--accent-cyan); }
        
        .contact-card.search-highlight,
        .on-call-week.search-highlight {
            background-color: var(--highlight-yellow);
            border-color: #FFC300;
            transform: scale(1.02);
        }
        .contact-card.search-highlight .title,
        .contact-card.search-highlight .info,
        .contact-card.search-highlight .clickable-tech,
        .on-call-week.search-highlight .dates,
        .on-call-week.search-highlight .members,
        .on-call-week.search-highlight .members strong,
        .on-call-week.search-highlight .clickable-tech {
            color: var(--bg-dark-blue);
            text-decoration-color: var(--bg-dark-blue);
        }

        #logout-button-container { display: block; }
        #admin-actions { display: none; }

        #branch-list { list-style: none; flex-grow: 1; }
        #branch-list li { color: var(--text-secondary); padding: 15px 10px; margin: 5px 0; border-radius: 6px; cursor: pointer; transition: all 0.2s ease-in-out; font-weight: 500; display: flex; justify-content: space-between; align-items: center; }
        #branch-list li:hover { background-color: var(--highlight-bg); color: var(--accent-cyan); }
        #branch-list li.active { background-color: var(--accent-cyan); color: var(--bg-dark-blue); font-weight: 600; }
        #branch-list li.active .arrow { border-color: var(--bg-dark-blue); }
        #branch-list li .arrow { width: 8px; height: 8px; border-right: 2px solid var(--text-secondary); border-bottom: 2px solid var(--text-secondary); transform: rotate(-45deg); transition: all 0.2s ease-in-out; }
        #branch-list li:hover .arrow { border-color: var(--accent-cyan); }
        
        .action-button { width: 100%; padding: 15px; margin-top: 10px; background-color: transparent; border: 1px solid var(--accent-cyan); border-radius: 6px; color: var(--accent-cyan); font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .action-button:hover { background-color: var(--highlight-bg); }
        
        .content-area { flex-grow: 1; padding: 40px; overflow-y: auto; position: relative; }
        .branch-details { display: none; }
        .branch-details.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .team-group { margin-bottom: 35px; }
        .team-group h2 { color: var(--accent-cyan); font-size: 1.3em; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .contact-card { background: var(--bg-light-blue); border: 1px solid var(--border-color); padding: 15px 20px; border-radius: 6px; margin-bottom: 10px; transition: all 0.2s ease-in-out; }
        .contact-card:hover { transform: scale(1.02); box-shadow: 0 0 15px rgba(100, 255, 218, 0.1); border-color: var(--accent-cyan); }
        .contact-card .title { color: var(--text-primary); font-weight: 500; display: flex; justify-content: space-between; align-items: center; }
        .contact-card .info { color: var(--text-secondary); font-size: 0.9em; }

        .on-call-schedule { display: flex; flex-direction: column; gap: 10px; }
        .on-call-week { background-color: var(--bg-light-blue); border: 1px solid var(--border-color); padding: 12px 15px; border-radius: 6px; transition: all 0.2s ease-in-out; border-left: 3px solid transparent; }
        .on-call-week .dates { font-weight: 600; color: var(--text-primary); margin-bottom: 5px; font-size: 1em; }
        .on-call-week .members { font-size: 0.9em; color: var(--text-secondary); }
        .on-call-week.current { background-color: var(--highlight-yellow); border-left: 3px solid #FFC300; border-color: #FFC300; }
        .on-call-week.current .dates, .on-call-week.current .members, .on-call-week.current .members strong, .on-call-week.current .clickable-tech { color: #0a192f; text-decoration-color: #0a192f; }
        
        .clickable-tech { cursor: pointer; text-decoration: underline; text-decoration-color: var(--accent-cyan); text-decoration-thickness: 1px; text-underline-offset: 3px; transition: color 0.2s, text-decoration-color 0.2s; }
        .clickable-tech:hover { color: var(--accent-cyan); }
        .clickable-tech.on-call-current { color: var(--accent-cyan); font-weight: bold; }
        .on-call-week.current .clickable-tech.on-call-current { color: #0a192f; }
        
        .observation-star { margin-left: 8px; color: var(--highlight-yellow); }

        #details-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
        #details-overlay.visible { opacity: 1; pointer-events: auto; }
        #technician-details-panel { position: fixed; top: 0; right: -450px; width: 420px; height: 100%; background-color: var(--bg-light-blue); border-left: 1px solid var(--border-color); box-shadow: -10px 0 30px var(--shadow-color); z-index: 1001; transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; }
        #technician-details-panel.open { right: 0; }
        .panel-content { padding: 25px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; flex-shrink: 0; }
        .panel-header h3 { color: var(--accent-cyan); font-size: 1.5em; }
        #panel-close-btn { font-size: 2.5em; color: var(--text-secondary); cursor: pointer; transition: color 0.2s; line-height: 1; }
        #panel-close-btn:hover { color: var(--accent-cyan); }
        .panel-section { margin-bottom: 25px; flex-shrink: 0; }
        .panel-section h4 { color: var(--text-primary); margin-bottom: 10px; font-size: 1.1em; }
        #panel-oncall-status { padding: 12px; border-radius: 6px; font-weight: 600; text-align: center; }
        #panel-oncall-status.active { background-color: var(--highlight-yellow); color: var(--bg-dark-blue); }
        #panel-oncall-status.inactive { background-color: var(--border-color); color: var(--text-secondary); }
        #panel-schedule-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .schedule-item { background-color: var(--bg-dark-blue); border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; }
        .schedule-item p { font-size: 0.9em; color: var(--text-secondary); }
        .schedule-item.current-schedule { background-color: var(--highlight-yellow); border-color: #FFC300; }
        .schedule-item.current-schedule p, .schedule-item.current-schedule p strong { color: var(--bg-dark-blue); }
        
        #panel-observations-list { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .observation-item { background-color: var(--bg-dark-blue); border: 1px solid var(--border-color); padding: 12px; border-radius: 6px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .observation-item p { flex-grow: 1; font-size: 0.9em; color: var(--text-secondary); white-space: pre-wrap; word-break: break-word; }
        .observation-item.highlighted { background-color: var(--highlight-yellow); }
        .observation-item.highlighted p { color: var(--bg-dark-blue); }
        .observation-actions { display: flex; gap: 8px; }
        .observation-actions button { background: none; border: none; cursor: pointer; font-size: 1.2em; }
        #observation-input { width: 100%; height: 80px; background-color: var(--bg-dark-blue); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); padding: 10px; resize: vertical; margin-bottom: 10px; }
        #add-observation-btn { width: 100%; padding: 10px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 25, 47, 0.8); backdrop-filter: blur(5px); z-index: 1002; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--bg-light-blue); border: 1px solid var(--border-color); padding: 30px; border-radius: 8px; width: 90%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h3 { color: var(--accent-cyan); margin-bottom: 10px; }
        .modal-content p { color: var(--text-secondary); margin-bottom: 20px; font-size: 0.9em; }
        #json-editor { width: 100%; flex-grow: 1; background-color: var(--bg-dark-blue); border: 1px solid var(--border-color); color: var(--text-primary); font-family: monospace; font-size: 14px; padding: 15px; border-radius: 6px; resize: none; }
        .modal-actions { margin-top: 20px; display: flex; gap: 15px; justify-content: flex-end; }
        .modal-actions .action-button { width: auto; padding: 10px 25px; }
        .modal-actions .secondary { border-color: var(--text-secondary); color: var(--text-secondary); }
        
        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; font-size: 0.8em; color: var(--text-secondary); line-height: 1.4; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2>Acesso ao Sistema</h2>
        <p>Organograma de Contatos</p>
        <form id="login-form">
            <div class="input-group">
                <label for="username">Usuário</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="input-group">
                <label for="password">Senha</label>
                <input type="password" id="password" name="password" required>
            </div>
            <p id="login-error"></p>
            <button type="submit" id="login-button">Acessar</button>
        </form>
    </div>

    <div class="container" id="main-content">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>Organograma</h1>
                <p>Contatos e Equipes por Filial</p>
                <div class="header-controls">
                    <div id="real-time-clock"></div>
                </div>
            </div>

            <div class="search-container">
                <input type="search" id="search-bar" placeholder="Buscar por filial ou técnico...">
            </div>

            <ul id="branch-list"></ul>
            <div class="sidebar-footer">
                 <div id="admin-actions">
                     <button class="action-button" id="edit-data-button">Adicionar/Editar Filial</button>
                 </div>
                 <div id="logout-button-container">
                      <button class="action-button" id="logout-button">Sair</button>
                 </div>
                 <p style="margin-top: 20px;">
                     Desenvolvido por<br>
                     Gabriel Hernesto Talasz<br>
                     & Maicon Gabriel Zipperer
                 </p>
            </div>
        </aside>
        <main class="content-area" id="content-area">
             <div id="details-wrapper"></div>
        </main>
    </div>

    <div id="details-overlay"></div>
    <div id="technician-details-panel">
        <div class="panel-content">
            <div class="panel-header">
                <h3 id="panel-tech-name">Nome do Técnico</h3>
                <span id="panel-close-btn">×</span>
            </div>
            <div class="panel-section">
                <h4>Status de Sobreaviso Atual</h4>
                <div id="panel-oncall-status">Verificando...</div>
            </div>
             <div class="panel-section" style="display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; min-height: 150px;">
                <h4>Próximas Escalas</h4>
                <div id="panel-schedule-list"></div>
            </div>
            <div class="panel-section" style="display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; min-height: 150px;">
                <h4>Observações</h4>
                <div id="panel-observations-list"></div>
            </div>
            <div class="panel-section">
                <h4>Adicionar Nova Observação</h4>
                <textarea id="observation-input" placeholder="Digite sua observação..."></textarea>
                <button id="add-observation-btn" class="action-button">Adicionar</button>
            </div>
        </div>
    </div>

    <div id="data-editor-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Editor de Dados</h3>
            <p>Adicione ou edite os dados abaixo no formato JSON. Clique em 'Salvar' para aplicar (a página será recarregada).</p>
            <textarea id="json-editor"></textarea>
            <div class="modal-actions">
                <button class="action-button secondary" id="cancel-data-button">Cancelar</button>
                <button class="action-button" id="save-data-button">Salvar e Recarregar</button>
            </div>
        </div>
    </div>

    <script id="mindmap-data" type="application/json">
    {
        "branches": [
            {
                "name": "Porto União (PUN)",
                "id": "pun-node",
                "teams": [
                    { "type": "Gestor", "contacts": ["JEISON (42 98810-2838)"] },
                    { "type": "Logística", "contacts": ["GUILHERME FELIPE REGERT STROHMAYER (42 8403-2349)"] },
                    { "type": "Implantação", "contacts": ["WILLIAL TAFAREL (42 8427-1332)", "PATRICK (42 9842-8267)", "MICAEL (42 9824-8419)"] },
                    { "type": "Suporte", "contacts": ["IRINEU (42 8861-9969)", "DOUGLAS KRESKO (42 8831-7158)", "RAFAEL ADAMI (42 9950-3944)"] },
                    { 
                        "type": "Escala de Sobreaviso - Suporte",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["RAFAEL ADAMI", "ERIVELTON"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["DOUGLAS KRESKO", "EMERSON"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["RAFAEL ADAMI", "ERIVELTON"]},
                            {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["DOUGLAS KRESKO", "EMERSON"]},
                            {"dates": "2025-09-29/2025-10-05", "display_dates": "29/09 a 05/10", "members": ["RAFAEL ADAMI", "ERIVELTON"]}
                        ]
                    },
                    { "type": "Localidades Vinculadas", "contacts": ["Paula Freitas (Suporte e Implantação)", "Irineópolis (Suporte e Implantação)"] }
                ]
            },
            {
                "name": "Itapoá (ITH)",
                "id": "ith-node",
                "teams": [
                    { "type": "Gestor", "contacts": ["MATEUS DE ANDRADE (49 8831-7755)"] },
                    { "type": "Logística", "contacts": ["Implantação: MONICA ROOS (41 8460-9583)", "Suporte: GISELE BUENO (47 9774-1206)", "Suporte: MONICA BRESOLIN (47 9148-2744)"] },
                    { "type": "Implantação", "contacts": ["JUAN NOGUEIRA (47 9 7448-8233)", "MARCOS ROBERTO PIRES (47 9 9160-2163)", "JEAN P LEDESMA (47 9 9754-8648)", "FAGNER SCHIMITT (47 9 9719-4357)", "LUIZ F FIOSA (47 9 9290-4649)", "MAICON ANDREY (49 9 8835-6791)", "DIOGO VELHO (47 99642-9842)"] },
                    { "type": "Suporte Técnico", "contacts": ["WELLINGTON MATHEUS MELLO (42 9 9123-6199)", "JONAS ELIEL (42 9 9185-9780 / 47 9 2505-5914)", "LAURO TAWAN (49 9 9178-1322)", "KAYO, BLENDON (47 9 9956-6791)", "EMANUEL MENDES (42 9 9127-9607)"] },
                    { "type": "Suporte Auxiliar", "contacts": ["MARCUS VINICIUS (47 9 9241-3861)", "MATHEUS OLIVEIRA (47 9 9721-3116)", "RENAN HENRIQUE (47 9 9226-7260)"] },
                    {
                        "type": "Escala de Sobreaviso - Suporte",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["EMANUEL MENDES DE PROENCA", "GILBERTO FERREIRA JUNIOR", "LAURO TAWAN OLIVEIRA COSTA", "RENAN HENRIQUE DA SILVA BENKENDORF"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["JONAS ELIEL RODRIGUES", "BRUNO HENRIQUE HALISKI VIEIRA", "WELLINGTON MATHEUS MELLO", "KAYO BLENDON GONCALVES"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["EMANUEL MENDES DE PROENCA", "GILBERTO FERREIRA JUNIOR", "LAURO TAWAN OLIVEIRA COSTA", "RENAN HENRIQUE DA SILVA BENKENDORF"]},
                             {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["KAYO BLENDON GONCALVES", "JOAO ANDRE DA CUNHA FILHO", "WELLINGTON MATHEUS MELLO", "MARCUS VINICIUS LISBOA LEDOUX"]},
                            {"dates": "2025-09-29/2025-10-05", "display_dates": "29/09 a 05/10", "members": ["EMANUEL MENDES DE PROENCA", "GILBERTO FERREIRA JUNIOR", "LAURO TAWAN OLIVEIRA COSTA", "RENAN HENRIQUE DA SILVA BENKENDORF"]}
                        ]
                    },
                    { "type": "Equipes por Localidade (Itapoá)", "contacts": ["GARUVA, BARRA DO SAÍ, CAMBIJU, RAINHA I, SUPORTE I, INSTALAÇÃO (JUAN, EMANUEL, MATHEUS)", "ITAPEMA NORTE, SAMAMBAIA, SAO JOSE I, 2 TERCEIROS, 2 SUPORTES (JEAN, FAGNER, JONAS, GIOVANE, KAIO)", "MAREDA, CENTRO, PAESE I, 1 TERCEIRO, 2 SUPORTES (MAICON/TECELI, LAURO, RENAN, MARCOS, GILBERTO)", "CONTINENTAL, PONTAL, AGUA BRANCA, SAO FRANCISCO I, 1 TERCEiro, 1 SUPORTE (DIOGO/ALEXANDRE, WELLINGTON, JOÃO)"] }
                ]
            },
            {
                "name": "Caçador (CDR)",
                "id": "cdr-node",
                "teams": [
                    { "type": "Gestor", "contacts": ["ERICA ZAINE (42 93505-6136)"] },
                    { "type": "Logística", "contacts": ["Suporte: JOAO VICTOR (42 99817-4036)", "Implantação: ALAN PACHECO (Afastado, Contatar JOÃO VICTOR 42 99843-3758)"] },
                    { "type": "Implantação", "contacts": ["VANDERLEI (49 98427-4690)", "MARCELO PRESTES (49 98827-2001)", "MARCELO AGNES (49 99952-4840)", "Terceiro: LUCAS OLIMPIO (49 92000-6538)", "RUAN ESTEVÃO (49 9989-7877)", "Terceiro: JORGE (49 99924-3993)"] },
                    { "type": "Suporte", "contacts": ["TADEU (49 98404-1192)", "ANDRE (49 99999-6012)", "SIDINEI (49 98859-4460)", "CLEVERSON LASTA (49 99815-0177)", "KELSON MATEUS (49 9989-7877)"] },
                    {
                        "type": "Escala de Sobreaviso - Suporte",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["Willians Matteus Schmitz", "Kelson Mateus Merelles", "Ruan de Oliveira Estevão", "Guilherme Antoniolli"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["Marcelo Ribeiro Prestes", "Wellington Dos Santos Ramos", "Vanderlei Francisco Bertolino Fragoso", "Igor Gustavo de Souza Pereira"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["Ruan de Oliveira Estevão", "Vinicius Lima"]},
                            {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["Marcelo Ribeiro Prestes", "Welligton dos Santos Ramos", "Vanderlei Francisco Bertolino Fragoso", "Igor"]},
                            {"dates": "2025-09-29/2025-10-05", "display_dates": "29/09 a 05/10", "members": ["Ruan de Oliveira Estevão", "Vinicius Lima"]}
                        ]
                    }
                ]
            },
            {
                "name": "Irati (IRI)",
                "id": "iri-node",
                "teams": [
                    { "type": "Gestor", "contacts": ["ANDRE CRISTO (42 9 2001-8184 / 42 9 3505-6126)"] },
                    { "type": "Logística (Suporte e Implantação)", "contacts": ["GUILHERME RANGEL (42 9 3505-6133)"] },
                    { "type": "Implantação", "contacts": ["MARCOS MARCONDES (42 9 9962-5343)", "RONALDO MARCONDES (42 9 9847-0630)", "Auxiliar: CLEVERTON PEDRO (42 9 9986-3271)"] },
                    { "type": "Suporte (IRI, FEP, TXR, IUV, PEI)", "contacts": ["DIEGO BONFIM (42 9 9927-0969)", "LUIZ RAMON (42 9 9870-8267)", "CESAR HENRIQUE (42 9 9944-9573)", "RAFAEL DE PADUA (42 9 9800-4553)", "ALISSON MOLINARI (42 9 9819-1404)"] },
                    { "type": "SSL", "contacts": ["HYURI LEPINSKI (42 9 8832-0737)", "Auxiliar: WELLIGHTON JOSE (42 9 8861-2363)"] },
                    {
                        "type": "Escala de Sobreaviso - Irati",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["CESAR HENRIQUE", "DIOGO", "PEDRO"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["RAMON", "DIOGO", "PEDRO"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["RAFAEL", "PEDRO", "CESAR HENRIQUE"]},
                            {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["CESAR HENRIQUE", "RAMON", "PEDRO"]},
                            {"dates": "2025-09-29/2025-10-05", "display_dates": "29/09 a 05/10", "members": ["RAMON", "ALISSON"]}
                        ]
                    },
                    {
                        "type": "Escala de Sobreaviso - São Mateus",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["WELLINGTON"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["HYURI"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["WELLINGTON", "HYURI"]},
                            {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["HYURI"]},
                            {"dates": "2025-09-29/2025-10-05", "display_dates": "29/09 a 05/10", "members": ["WELLINGTON"]}
                        ]
                    }
                ]
            },
            {
                "name": "Canoinhas (CNI)",
                "id": "cni-node",
                "teams": [
                    { "type": "Gestor Geral", "contacts": ["JEISON (42 98810-2838)"] },
                    { "type": "Logística", "contacts": ["Suporte: GABRIEL HERNESTO (42 98869-9699)", "Implantação: LAIANE DURAU (47 99274-6274)", "Upgrade: ELEN JAINE (47 9 8496-9673)"] },
                    { "type": "Equipe Canoinhas (Implantação)", "contacts": ["ALEXANDRE (47 99685-6642)", "EVERTON (47 98479-3702)", "KAUAN (47 99292-9564)", "JEFFERSON (47 9609-639)"] },
                    { "type": "Equipe Canoinhas (Suporte)", "contacts": ["ANDREI CARVALHO (47 8410-0075)", "LUCAS DE CAMARGO (47 9934-9287)", "AXEL PIERRI (47 8404-4131)", "LUIS PAULO PEREIRA (47 99783-0108)"] },
                    { "type": "Equipe Papanduva (PPV)", "contacts": ["Suporte/Implantação: MARCIO ANTUNES (47 93505-5979)"] },
                    { "type": "Equipe Itaiópolis (ILS)", "contacts": ["Suporte/Implantação: RAFAEL ORTH (42 98874-2801)"] },
                     {
                        "type": "Escala de Sobreaviso - CNI/TBS",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["Luis Paulo", "Andrei"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["Lucas Camargo", "Alex"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["Axel pierre", "Andrei"]},
                            {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["Luis Paulo", "Alex"]}
                        ]
                    },
                    {
                        "type": "Escala de Sobreaviso - PPV/ILS/MOT",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["Raffael Orth", "Denis"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["Marcio Antunes", "João"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["Raffael Orth", "Denis"]},
                            {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["Marcio Antunes", "João"]},
                            {"dates": "2025-09-29/2025-10-05", "display_dates": "29/09 a 05/10", "members": ["Raffael Orth", "Denis"]}
                        ]
                    }
                ]
            },
            { "name": "Chapecó (CCO)", "id": "cco-node", "teams": [ { "type": "Gestor", "contacts": ["BRUNO SBARAINI (49 8427-7527)"] }, { "type": "Implantação (Empresas Terceirizadas)", "contacts": ["EMP CLIQUE - 03 (49 9133-4693)", "EMP JUNIOR (48 9121-7283)", "EMP KGC (49 8895-8308)", "EMP RICARDO (Livre)"] }, { "type": "Suporte", "contacts": ["Lentidão: MATHEUS ROCHA (49 9811-0102)", "Sem Acesso: RAICLAN FERREIRA (49 9173-6972)", "THOMAS LUIZ (Agenda Livre)", "Sem Acesso: JAMISSON (49 9185-0649)"] } ] },
            { 
                "name": "Curitibanos (CBS)", 
                "id": "cbs-node", 
                "teams": [ 
                    { "type": "Gestor Geral", "contacts": ["ROBSON CARLOS TIZOTTI (49 9921-0590)"] }, 
                    { "type": "Logística", "contacts": ["JORDAN ANDRE FREITAS (42 99817-4036)"] }, 
                    { "type": "Equipe Curitibanos", "contacts": ["Suporte/Implantação: CALONE (49 98917-2676)", "Implantação Terceiro: GABRIEL (49 93380-9316)", "Implantação Terceiro: JOAO FELIPE (49 8871-4363)"] }, 
                    { "type": "Equipe Santa Cecilia (STAC)", "contacts": ["Implantação/Suporte: ALISSON (49 99109-0598)", "Implantação/Suporte: EDUARDO (49 991412919)"] }, 
                    { "type": "Equipe Fraiburgo (FGO)", "contacts": ["Implantação/Suporte: LEOMAR (49 9830-1119)"] },
                    {
                        "type": "Escala de Sobreaviso",
                        "schedule": [
                            {"dates": "2025-09-01/2025-11-09", "display_dates": "01/09 a 09/11", "members": ["Nenhum técnico escalado para este período"] }
                        ]
                    }
                ] 
            },
            { "name": "Joaçaba (JBA)", "id": "jba-node", "teams": [ { "type": "Gestor Geral", "contacts": ["BRUNO BORINI (42 92001-1461)"] }, { "type": "Logística", "contacts": ["ALINE FRACARI PEREIRA (49 9 9914-0346)"] }, { "type": "Equipe Joaçaba", "contacts": [ "Implantação: LEOMIR ALVES DA SILVA (49 9 9910-0241)", "Auxiliar: DANIEL AGRIPINO (49 9 9168-3065)", "Terceiro: ALTAIR FERNANDES SCAPINI (49 9 9111-9806)", "Terceiro (FIT/BFTTA): VITOR ANTUNES (49 9 9834-8822)", "Suporte (Sem Acesso): GABRIEL JOSE ALVES (49 9 9971-2328)", "Suporte: RAFAEL CARVALHO (49 9 9915-1278)"] }, { "type": "Equipe Catanduvas (CAT)", "contacts": [ "Suporte/Implantação: WILLIAM ALVES (49 9 9181-4004)", "Auxiliar: GUILHERME PASOLD (50 9 9825-6524)" ] } ] },
            {
                "name": "Videira (VII)",
                "id": "vii-node",
                "teams": [
                    { "type": "Gestor", "contacts": ["BRUNO BORINI (42 92001-1461)"] },
                    { "type": "Logística", "contacts": ["Implantação: GILVANDRO GUILL (49 99111-0765 / 49 99111-0765)", "Suporte: GESSICA APARECIDA (49 93505-0826)"] },
                    { "type": "Implantação", "contacts": ["UALTER RIBEIRO (49 99202-5568)", "EZEQUIEL RAMOS (42 99929-1894)", "VALDOMIRO KELVER (49 99111-9806)", "CHRISTIAN CENDRON (49 99124-8141)"] },
                    { "type": "Suporte", "contacts": ["MARCELO ZANUSO/GIORDAN (49 99154-7781 / 49 99192-7653)", "Sem Acesso: LUCAS HENRIQUE (49 99911-2799)", "Sem Acesso: FERNANDO DE JESUS (49 99911-2248)"] },
                    { "type": "Suporte Upgrade", "contacts": ["JEFFERSON KAFFER (49 99950-7753)", "HENRIQUE DELCIR (49 99170-0702)"] },
                    {
                        "type": "Escala de Sobreaviso - Suporte",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["Ezequiel R. do Bonfim", "Dionathan Danielewicz"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["Fernando de Jesus Roque", "Gilmar Pelentir"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["Kauan Viergutz Maidana", "Reelberti R. da Luz"]},
                            {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["Ezequiel R. do Bonfim", "Dionathan Danielewicz"]},
                            {"dates": "2025-09-29/2025-10-05", "display_dates": "29/09 a 05/10", "members": ["Fernando de Jesus Roque", "Gilmar Pelentir"]}
                        ]
                    }
                ]
            },
            { "name": "Rio do Sul (RSL)", "id": "rsl-node", "teams": [ { "type": "Gestor", "contacts": ["BRUNO BUCHOLZ (49 99928-9094)"] }, { "type": "Logística", "contacts": ["MARCIO HONORIO (47 98822-8458)"] }, { "type": "Suporte/Implantação", "contacts": ["FELIPE JUVENAL (47 999716-3666)", "RAFAEL MEDEIROS (49 99114-3952)", "BRUNO ANDRESLEY (47 99128-7618) - ILIPIAL/KALI/YVRM", "DIEGO ROSA (47 98865-7771)", "WEVERTON GODARSKI (49 99982-0547) - IRRLOS"] }, { "type": "Auxiliares", "contacts": ["GUSTAVO FELIPE SANTOS (47 93505-5998) - Aux Felipe", "AURELIO (Aux Rafael)", "JOAO VITOR FARIAS (47 9 9166-7205) - Aux Diego", "WILLIAM VICTOR (47 99706-2277) - Aux Weverton (IRRLOS)"] } ] },
            { "name": "Itajaí (IAI)", "id": "iai-node", "teams": [ { "type": "Gestor", "contacts": ["BRUNO BUCHOLZ (49 99928-094)"] }, { "type": "Logística", "contacts": ["MARCIO HONORIO (47 98822-8458)"] }, { "type": "Suporte/Implantação", "contacts": ["MATHEUS MARTINS SOARES (47 9 3505-5981)"] }, { "type": "Auxiliar", "contacts": ["MARCELO GUSTAVO BECHER (47 9 8801-7594)"] } ] },
            {
                "name": "Piên (PYE)",
                "id": "pye-node",
                "teams": [
                     {
                        "type": "Escala de Sobreaviso - Piên e Região",
                        "schedule": [
                            {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["ELISSON ANTONIO DILL", "THIAGO DE LIMA"]},
                            {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["LUCAS CIECILISNKI KIRSCHBAUER", "PAULO CESAR AVANCI"]},
                            {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["DOOUGLAS SILVA PEREIRA", "WESLEY DE PAULA DA SILVA", "ANDRÉ RICARDO BAUM"]},
                            {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["ANDRÉ RICARDO BAUM", "CHRISTIAN LEONAM CARNEIRO", "DOUGLAS SILVA PEREIRA"]},
                            {"dates": "2025-09-29/2025-09-30", "display_dates": "29/09 a 30/09", "members": ["ELISSON ANTONIO DILL", "THIAGO DE LIMA"]}
                        ]
                    },
                    {
                        "type": "Escala de Sobreaviso - Mandirituba e Quitandinha",
                        "schedule": [
                           {"dates": "2025-09-01/2025-09-07", "display_dates": "01/09 a 07/09", "members": ["ALESSANDRO APARECIDO MOREIRA DE ANDRADE"]},
                           {"dates": "2025-09-08/2025-09-14", "display_dates": "08/09 a 14/09", "members": ["JULIAN TABORDA DE DEUS"]},
                           {"dates": "2025-09-15/2025-09-21", "display_dates": "15/09 a 21/09", "members": ["ALESSANDRO APARECIDO MOREIRA DE ANDRADE", "ALEF RAFAEL DOS SANTOS", "TIAGO ARLAN DOS SANTOS"]},
                           {"dates": "2025-09-22/2025-09-28", "display_dates": "22/09 a 28/09", "members": ["ALESSANDRO APARECIDO MOREIRA DE ANDRADE", "JULIAN TABORDA DE DEUS"]},
                           {"dates": "2025-09-29/2025-09-30", "display_dates": "29/09 a 30/09", "members": ["ALEF RAFAEL DOS SANTOS", "TIAGO ARLAN DOS SANTOS"]}
                        ]
                    }
                ]
            }
        ]
    }
    </script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ELEMENTOS DA UI ---
        const dataScript = document.getElementById('mindmap-data');
        let data = {};
        let clockInterval = null;
        let currentTechName = null;
        
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const branchList = document.getElementById('branch-list');
        const detailsWrapper = document.getElementById('details-wrapper');
        const adminActions = document.getElementById('admin-actions');
        const logoutButton = document.getElementById('logout-button');
        const editDataButton = document.getElementById('edit-data-button');
        const clockElement = document.getElementById('real-time-clock');
        const searchBar = document.getElementById('search-bar');

        const techPanel = document.getElementById('technician-details-panel');
        const detailsOverlay = document.getElementById('details-overlay');
        const panelCloseBtn = document.getElementById('panel-close-btn');
        const panelTechName = document.getElementById('panel-tech-name');
        const panelOncallStatus = document.getElementById('panel-oncall-status');
        const panelScheduleList = document.getElementById('panel-schedule-list');
        const panelObservationsList = document.getElementById('panel-observations-list');
        const observationInput = document.getElementById('observation-input');
        const addObservationBtn = document.getElementById('add-observation-btn');
        
        const modalOverlay = document.getElementById('data-editor-modal');
        const jsonEditor = document.getElementById('json-editor');
        const saveDataButton = document.getElementById('save-data-button');
        const cancelDataButton = document.getElementById('cancel-data-button');

        const users = { admin: 'padrao123', user: 'gegcli2014' };
        
        // --- FUNÇÕES DE DATA E HORA ---
        function isCurrentWeek(dateRangeString) {
            try {
                const [startStr, endStr] = dateRangeString.split('/');
                const now = new Date();
                const startDate = new Date(startStr + 'T00:00:00');
                const endDate = new Date(endStr + 'T23:59:59');
                return now >= startDate && now <= endDate;
            } catch (e) { return false; }
        }
        
        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(() => {
                const now = new Date();
                clockElement.textContent = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }, 1000);
        }

        function extractBaseName(contactString) {
            if (!contactString || typeof contactString !== 'string') return '';
            return contactString.split('(')[0].trim();
        }
        
        function hasObservation(techName) {
            const key = `observations_${extractBaseName(techName)}`;
            const observations = JSON.parse(localStorage.getItem(key)) || [];
            return observations.length > 0;
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function initializeContent() {
            try {
                const savedData = localStorage.getItem('mindmapData');
                data = savedData ? JSON.parse(savedData) : JSON.parse(dataScript.textContent);
            } catch (e) {
                console.error("Erro ao carregar dados JSON:", e);
                data = { branches: [] };
            }
            
            branchList.innerHTML = '';
            detailsWrapper.innerHTML = '';

            if (!data || !data.branches) return;

            // Renderiza filiais do JSON
            data.branches.forEach((branch) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${branch.name}</span><span class="arrow"></span>`;
                li.dataset.target = branch.id;
                branchList.appendChild(li);

                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'branch-details';
                detailsDiv.id = branch.id;

                branch.teams.forEach(team => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'team-group';
                    let teamHTML = `<h2>${team.type}</h2>`;
                    
                    if (team.schedule) {
                        let scheduleHTML = '<div class="on-call-schedule">';
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);

                        team.schedule.forEach(week => {
                             try {
                                const [startStr, endStr] = week.dates.split('/');
                                const startDate = new Date(startStr);
                                const endDate = new Date(endStr);
                                endDate.setHours(23, 59, 59, 999); // Garante que a data final inclua o dia inteiro.

                                if (endDate >= today) {
                                    const isCurrent = isCurrentWeek(week.dates);
                                    const clickableMembers = week.members.map(member => makeNamesClickable(member)).join(' | ');
                                    scheduleHTML += `<div class="on-call-week ${isCurrent ? 'current' : ''}" data-schedule-members="${week.members.join(',')}"><div class="dates">Semana: ${week.display_dates}</div><div class="members"><strong>Equipe:</strong> ${clickableMembers}</div></div>`;
                                }
                            } catch(e) { console.error("Erro ao processar data da escala: ", week.dates)}
                        });
                        scheduleHTML += '</div>';
                        teamHTML += scheduleHTML;
                    } else {
                        team.contacts.forEach(contact => {
                            const parts = contact.split(': ');
                            const mainInfo = parts.length > 1 ? parts[1] : contact;
                            const titleHTML = makeNamesClickable(mainInfo);
                            
                            const contactHTML = (parts.length > 1) 
                                ? `<div class="info">${parts[0]}:</div><div class="title">${titleHTML}</div>` 
                                : `<div class="title">${titleHTML}</div>`;
                            teamHTML += `<div class="contact-card" data-contact="${contact}">${contactHTML}</div>`;
                        });
                    }
                    
                    groupDiv.innerHTML = teamHTML;
                    detailsDiv.appendChild(groupDiv);
                });
                detailsWrapper.appendChild(detailsDiv);
            });

            // Adiciona abas estáticas
            const ramalLi = document.createElement('li');
            ramalLi.innerHTML = '<span>Ramal</span><span class="arrow"></span>';
            ramalLi.dataset.target = 'ramal-content';
            branchList.appendChild(ramalLi);

            const mapaLi = document.createElement('li');
            mapaLi.innerHTML = '<span>Mapa</span><span class="arrow"></span>';
            mapaLi.dataset.target = 'mapa-redirect'; // Apenas para identificação
            branchList.appendChild(mapaLi);

            const ramalDetailsDiv = document.createElement('div');
            ramalDetailsDiv.className = 'branch-details';
            ramalDetailsDiv.id = 'ramal-content';
            ramalDetailsDiv.innerHTML = '<div class="team-group"><h2>Ramais</h2><p>Funcionalidade em desenvolvimento.</p></div>';
            detailsWrapper.appendChild(ramalDetailsDiv);

            // Adiciona event listeners para todas as abas
            document.querySelectorAll('#branch-list li').forEach(item => {
                item.addEventListener('click', function() {
                    const targetId = this.dataset.target;
                    
                    if (targetId === 'mapa-redirect') {
                        window.open('https://www.google.com/maps/d/u/0/edit?mid=1VP4_joA90IUIB_DsIBjDhVyf1H7tpuY', '_blank');
                        return; // Não altera a aba ativa
                    }
                    
                    document.querySelectorAll('#branch-list li').forEach(li => li.classList.remove('active'));
                    document.querySelectorAll('.branch-details').forEach(div => div.classList.remove('active'));
                    this.classList.add('active');
                    const targetDiv = document.getElementById(targetId);
                    if(targetDiv) {
                        targetDiv.classList.add('active');
                        handleSearchHighlight();
                    }
                });
            });

            if (document.querySelectorAll('#branch-list li:not([data-target="mapa-redirect"])').length > 0) {
                document.querySelectorAll('#branch-list li:not([data-target="mapa-redirect"])')[0].click();
            }
        }

        function makeNamesClickable(contactString) {
            const baseName = extractBaseName(contactString);
            const hasObs = hasObservation(baseName);
            const starIcon = hasObs ? '<span class="observation-star"> ⭐</span>' : '';
            const onCallClass = getOnCallStatus(baseName) ? 'on-call-current' : '';
            const finalClass = `${onCallClass}`;
            const restOfString = contactString.substring(baseName.length);
            return `<span class="clickable-tech ${finalClass}" data-tech-name="${baseName}">${baseName}</span>${starIcon}<span class="info">${restOfString}</span>`;
        }
        
        function handleSearchHighlight() {
            const searchTerm = searchBar.value.toLowerCase().trim();
            document.querySelectorAll('.contact-card, .on-call-week').forEach(c => c.classList.remove('search-highlight'));
            if (searchTerm) {
                const activeDetails = document.querySelector('.branch-details.active');
                if (activeDetails) {
                    activeDetails.querySelectorAll('.contact-card').forEach(card => {
                        if (card.dataset.contact && card.dataset.contact.toLowerCase().includes(searchTerm)) {
                            card.classList.add('search-highlight');
                        }
                    });
                     activeDetails.querySelectorAll('.on-call-week').forEach(week => {
                        if (week.dataset.scheduleMembers && week.dataset.scheduleMembers.toLowerCase().includes(searchTerm)) {
                            week.classList.add('search-highlight');
                        }
                    });
                }
            }
        }

        function handleSearch() {
            const searchTerm = searchBar.value.toLowerCase().trim();

            document.querySelectorAll('#branch-list li, .branch-details').forEach(el => {
                el.classList.remove('active');
                el.style.display = ''; 
            });

            if (!searchTerm) {
                if (document.querySelectorAll('#branch-list li').length > 0) {
                    document.querySelectorAll('#branch-list li')[0].click();
                }
                handleSearchHighlight();
                return;
            }

            const matchingBranchIds = new Set();
            data.branches.forEach(branch => {
                const branchNameMatch = branch.name.toLowerCase().includes(searchTerm);
                let contactMatch = false;
                branch.teams.forEach(team => {
                    const contacts = team.contacts || (team.schedule ? team.schedule.flatMap(w => w.members) : []);
                    if (contacts.some(contact => contact.toLowerCase().includes(searchTerm))) {
                        contactMatch = true;
                    }
                });

                if(branchNameMatch || contactMatch) {
                    matchingBranchIds.add(branch.id);
                }
            });

            document.querySelectorAll('#branch-list li').forEach(li => {
                 if (li.dataset.target && !li.dataset.target.includes('-content') && !li.dataset.target.includes('-redirect')) {
                     li.style.display = matchingBranchIds.has(li.dataset.target) ? 'flex' : 'none';
                 }
            });

            const firstVisibleLi = document.querySelector('#branch-list li:not([style*="display: none"])');
            if (firstVisibleLi) {
                firstVisibleLi.click();
            } else {
                 document.querySelectorAll('.branch-details').forEach(div => div.classList.remove('active'));
                 detailsWrapper.innerHTML = `<div class="branch-details active"><div class="team-group"><h2>Nenhum resultado encontrado para "${searchBar.value}"</h2></div></div>`;
            }
            handleSearchHighlight();
        }
        searchBar.addEventListener('input', handleSearch);
        
        // --- FUNÇÕES DO PAINEL DE DETALHES ---
        function getOnCallStatus(techName) {
            let onCall = false;
            const baseTechName = extractBaseName(techName).toUpperCase();
            
            data.branches.forEach(branch => {
                branch.teams.forEach(team => {
                    if (team.schedule) {
                        team.schedule.forEach(week => {
                            if (isCurrentWeek(week.dates)) {
                                if (week.members.some(member => extractBaseName(member).toUpperCase() === baseTechName)) {
                                    onCall = true;
                                }
                            }
                        });
                    }
                });
            });
            return onCall;
        }

        function openPanel(techName) {
            currentTechName = techName;
            panelTechName.textContent = currentTechName;
            
            const isOnCall = getOnCallStatus(currentTechName);
            panelOncallStatus.textContent = isOnCall ? 'ATIVO NO SOBREAVISO ESTA SEMANA' : 'Fora do sobreaviso esta semana';
            panelOncallStatus.className = isOnCall ? 'active' : 'inactive';

            panelScheduleList.innerHTML = '';
            let futureSchedulesHTML = '';
            let hasSchedule = false;

            data.branches.forEach(branch => {
                branch.teams.forEach(team => {
                    if (team.schedule) {
                        team.schedule.forEach(week => {
                            if (week.members.some(member => extractBaseName(member).toUpperCase() === currentTechName.toUpperCase())) {
                                const isCurrent = isCurrentWeek(week.dates);
                                futureSchedulesHTML += `<div class="schedule-item ${isCurrent ? 'current-schedule' : ''}"><p><strong>Semana:</strong> ${week.display_dates}</p><p><strong>Equipe:</strong> ${team.type.replace('Escala de Sobreaviso - ', '')}</p></div>`;
                                hasSchedule = true;
                            }
                        });
                    }
                });
            });

            if (!hasSchedule) {
                futureSchedulesHTML = '<p style="color: var(--text-secondary); font-size: 0.9em;">Nenhuma escala futura encontrada.</p>';
            }
            panelScheduleList.innerHTML = futureSchedulesHTML;

            renderObservations();

            techPanel.classList.add('open');
            detailsOverlay.classList.add('visible');
        }

        function closePanel() {
            techPanel.classList.remove('open');
            detailsOverlay.classList.remove('visible');
            currentTechName = null;
        }
        
        // --- FUNÇÕES DE OBSERVAÇÃO ---
        function getObservations() {
            if (!currentTechName) return [];
            const key = `observations_${currentTechName}`;
            return JSON.parse(localStorage.getItem(key)) || [];
        }

        function saveObservations(observations) {
            if (!currentTechName) return;
            const key = `observations_${currentTechName}`;
            localStorage.setItem(key, JSON.stringify(observations));
            initializeContent(); 
        }

        function renderObservations() {
            panelObservationsList.innerHTML = '';
            const observations = getObservations();
            if (observations.length === 0) {
                panelObservationsList.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9em;">Nenhuma observação adicionada.</p>';
                return;
            }

            observations.forEach(obs => {
                const item = document.createElement('div');
                item.className = `observation-item ${obs.highlighted ? 'highlighted' : ''}`;
                item.innerHTML = `
                    <p>${obs.text}</p>
                    <div class="observation-actions">
                        <button data-id="${obs.id}" class="highlight-btn" title="Destacar">⭐</button>
                        <button data-id="${obs.id}" class="delete-btn" title="Excluir">🗑️</button>
                    </div>`;
                panelObservationsList.appendChild(item);
            });
        }
        
        // --- EVENT LISTENERS GERAIS ---
        addObservationBtn.addEventListener('click', () => {
            const text = observationInput.value.trim();
            if (text) {
                let observations = getObservations();
                observations.unshift({ id: Date.now(), text: text, highlighted: false });
                saveObservations(observations);
                renderObservations();
                observationInput.value = '';
            }
        });

        panelObservationsList.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            const id = Number(target.dataset.id);
            let observations = getObservations();
            
            if (target.classList.contains('highlight-btn')) {
                const obs = observations.find(o => o.id === id);
                if (obs) obs.highlighted = !obs.highlighted;
            }
            if (target.classList.contains('delete-btn')) {
                observations = observations.filter(o => o.id !== id);
            }
            saveObservations(observations);
            renderObservations();
        });
        
        detailsWrapper.addEventListener('click', function(e) {
            const clickable = e.target.closest('.clickable-tech');
            if (clickable) {
                const techName = clickable.getAttribute('data-tech-name');
                openPanel(techName);
            }
        });
        
        panelCloseBtn.addEventListener('click', closePanel);
        detailsOverlay.addEventListener('click', closePanel);
        
        // --- LÓGICA DE LOGIN, LOGOUT E SESSÃO ---
        function showLoginScreen() { if (clockInterval) clearInterval(clockInterval); mainContent.classList.remove('visible'); loginScreen.classList.remove('hidden'); loginForm.reset(); sessionStorage.removeItem('loggedInUser'); }
        function showMainScreen(username) { loginScreen.classList.add('hidden'); mainContent.classList.add('visible'); adminActions.style.display = (username === 'admin') ? 'block' : 'none'; startClock(); initializeContent(); }

        loginForm.addEventListener('submit', function(event) { event.preventDefault(); const username = loginForm.username.value; const password = loginForm.password.value; if (users[username] && users[username] === password) { loginError.textContent = ''; sessionStorage.setItem('loggedInUser', username); showMainScreen(username); } else { loginError.textContent = 'Usuário ou senha inválidos.'; } });
        
        logoutButton.addEventListener('click', showLoginScreen);
        
        const loggedInUser = sessionStorage.getItem('loggedInUser');
        if (loggedInUser) {
            showMainScreen(loggedInUser);
        }
    });
    </script>
</body>
</html>